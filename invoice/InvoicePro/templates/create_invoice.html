{% extends "base.html" %}

{% block title %}Create Invoice - Revolutionary Invoice System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-6 fw-bold text-primary mb-1">
                            <i data-feather="file-plus" class="me-2"></i>
                            Create New Invoice
                        </h1>
                        <p class="text-muted mb-0">
                            Generate professional invoices with AI assistance
                            {% if ai_enabled %} â€¢ Voice commands enabled{% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex gap-2 justify-content-end">
                            {% if ai_enabled %}
                            <button class="btn btn-success glass-btn" id="voiceAssistBtn">
                                <i data-feather="mic" class="me-1"></i> Voice Assist
                            </button>
                            <button class="btn btn-info glass-btn" data-bs-toggle="modal" data-bs-target="#documentScannerModal">
                                <i data-feather="camera" class="me-1"></i> Scan Document
                            </button>
                            {% endif %}
                            <a href="{{ url_for('invoice_management') }}" class="btn btn-outline-secondary glass-btn">
                                <i data-feather="arrow-left" class="me-1"></i> Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invoice Form -->
    <form method="POST" id="invoiceForm">
        <div class="row">
            <!-- Left Column - Invoice Details -->
            <div class="col-lg-8">
                <div class="glass-card p-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i data-feather="info" class="me-2 text-primary"></i>
                        Invoice Information
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client_id" class="form-label">Client *</label>
                                <div class="input-group">
                                    <select class="form-select glass-input" id="client_id" name="client_id" required>
                                        <option value="">Select a client...</option>
                                        {% for client in clients %}
                                        <option value="{{ client.id }}" 
                                                data-email="{{ client.email }}" 
                                                data-phone="{{ client.phone }}"
                                                data-address="{{ client.address }}"
                                                data-gstin="{{ client.gstin }}">
                                            {{ client.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <a href="{{ url_for('create_client') }}" class="btn btn-outline-primary" >
                                        <i data-feather="user-plus" size="16"></i>
                                    </a>
                                </div>
                                <div id="clientPreview" class="client-preview mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <div id="clientInfo"></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="invoice_date" class="form-label">Invoice Date *</label>
                                <input type="date" class="form-control glass-input" id="invoice_date" name="invoice_date" 
                                       value="{{ today.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control glass-input" id="due_date" name="due_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control glass-input" id="notes" name="notes" rows="3" 
                                          placeholder="Additional notes for this invoice..."></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="terms_conditions" class="form-label">Terms & Conditions</label>
                                <textarea class="form-control glass-input" id="terms_conditions" name="terms_conditions" rows="3" 
                                          placeholder="Payment terms and conditions...">Payment due within 30 days of invoice date.
Interest @ 2% per month will be charged on overdue amounts.
Subject to local jurisdiction only.</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Line Items -->
                <div class="glass-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">
                            <i data-feather="list" class="me-2 text-primary"></i>
                            Invoice Items
                        </h5>
                        <div class="d-flex gap-2">
                            {% if ai_enabled %}
                            <button type="button" class="btn btn-info btn-sm glass-btn" id="aiSuggestionsBtn">
                                <i data-feather="cpu" class="me-1"></i> AI Suggestions
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-primary btn-sm glass-btn" id="addItemBtn">
                                <i data-feather="plus" class="me-1"></i> Add Item
                            </button>
                        </div>
                    </div>
                    
                    <!-- Items Table -->
                    <div class="table-responsive">
                        <table class="table table-borderless" id="itemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">#</th>
                                    <th width="100">HSN Code</th>
                                    <th>Description *</th>
                                    <th width="80">Qty *</th>
                                    <th width="100">Unit</th>
                                    <th width="120">Rate *</th>
                                    <th width="80">Tax %</th>
                                    <th width="120">Amount</th>
                                    <th width="80">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- AI Suggestions Panel -->
                    {% if ai_enabled %}
                    <div id="aiSuggestionsPanel" class="ai-suggestions-panel mt-3" style="display: none;">
                        <div class="glass-card-sm p-3">
                            <h6 class="text-primary mb-2">
                                <i data-feather="cpu" class="me-1"></i> AI Suggestions
                            </h6>
                            <div id="aiSuggestionsList">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                    <small class="text-muted">Generating suggestions...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column - Summary and Actions -->
            <div class="col-lg-4">
                <!-- Invoice Summary -->
                <div class="glass-card p-4 mb-4 sticky-summary">
                    <h5 class="fw-bold mb-3">
                        <i data-feather="calculator" class="me-2 text-primary"></i>
                        Invoice Summary
                    </h5>
                    
                    <div class="summary-section">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotalAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>CGST (9%):</span>
                            <span id="cgstAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>SGST (9%):</span>
                            <span id="sgstAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>IGST (18%):</span>
                            <span id="igstAmount">â‚¹0.00</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between fw-bold text-primary h5">
                            <span>Total Amount:</span>
                            <span id="totalAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Amount in Words:</strong><br>
                                <span id="amountInWords">Zero Rupees Only</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-2">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary glass-btn-primary" id="saveInvoiceBtn">
                                <i data-feather="save" class="me-1"></i> Save Invoice
                            </button>
                            
                            <button type="button" class="btn btn-outline-secondary glass-btn" id="previewBtn">
                                <i data-feather="eye" class="me-1"></i> Preview
                            </button>
                            
                            {% if ai_enabled %}
                            <button type="button" class="btn btn-outline-info glass-btn" id="aiAnalyzeBtn">
                                <i data-feather="cpu" class="me-1"></i> AI Analysis
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Invoice Options -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-2">Options</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableQRCode" checked>
                            <label class="form-check-label" for="enableQRCode">
                                Generate QR Code for payments
                            </label>
                        </div>
                        
                        {% if blockchain_enabled %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="blockchainVerify" checked>
                            <label class="form-check-label" for="blockchainVerify">
                                Add to blockchain for verification
                            </label>
                        </div>
                        {% endif %}
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoReminders">
                            <label class="form-check-label" for="autoReminders">
                                Set up automatic payment reminders
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Client Information (if selected) -->
                <div id="clientInfoCard" class="glass-card p-4" style="display: none;">
                    <h6 class="fw-bold mb-2">
                        <i data-feather="user" class="me-2 text-primary"></i>
                        Client Information
                    </h6>
                    <div id="clientDetails"></div>
                </div>
            </div>
        </div>
        
        <!-- Hidden Fields -->
        <input type="hidden" id="line_items" name="line_items" value="[]">
        <input type="hidden" id="ai_generated" name="ai_generated" value="false">
        <input type="hidden" id="voice_created" name="voice_created" value="false">
    </form>
</div>

<!-- Item Row Template -->
<template id="itemRowTemplate">
    <tr class="item-row">
        <td>
            <span class="item-number">1</span>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm glass-input" 
                   placeholder="HSN" name="hsn_code">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm glass-input" 
                   placeholder="Item description" name="description" required>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm glass-input" 
                   placeholder="1" name="quantity" min="0" step="0.01" required>
        </td>
        <td>
            <select class="form-select form-select-sm glass-input" name="unit">
                <option value="Nos">Nos</option>
                <option value="Kg">Kg</option>
                <option value="Ltr">Ltr</option>
                <option value="Mtr">Mtr</option>
                <option value="Hrs">Hrs</option>
                <option value="Days">Days</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm glass-input" 
                   placeholder="0.00" name="unit_price" min="0" step="0.01" required>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm glass-input" 
                   placeholder="18" name="tax_percentage" min="0" max="100" step="0.01" value="18">
        </td>
        <td>
            <div class="item-amount fw-bold">â‚¹0.00</div>
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn">
                <i data-feather="trash-2" size="14"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}
{% block scripts %}
<script>
let itemCounter = 0;
let lineItems = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize first row
    addItemRow();

    // Add new item row button
    document.getElementById('addItemBtn').addEventListener('click', addItemRow);

    // Form submission
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveInvoice();
    });
});

// Add a new invoice item row
function addItemRow(suggestion = null) {
    itemCounter++;
    const template = document.getElementById('itemRowTemplate');
    const clone = template.content.cloneNode(true); // deep clone
    const row = clone.querySelector('.item-row');

    // Update item number
    row.querySelector('.item-number').textContent = itemCounter;

    // If suggestion passed (AI), populate fields
    if (suggestion) {
        row.querySelector('[name="description"]').value = suggestion.description || '';
        row.querySelector('[name="quantity"]').value = suggestion.quantity || 1;
        row.querySelector('[name="unit_price"]').value = suggestion.unit_price || 0;
        row.querySelector('[name="hsn_code"]').value = suggestion.hsn_code || '';
    }

    // Add event listeners for calculation
    const inputs = row.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            calculateItemAmount(row);
            updateInvoiceSummary();
        });
        input.addEventListener('change', () => {
            calculateItemAmount(row);
            updateInvoiceSummary();
        });
    });

    // Remove button
    row.querySelector('.remove-item-btn').addEventListener('click', () => {
        removeItemRow(row);
    });

    // Append row to table
    document.getElementById('itemsTableBody').appendChild(clone);

    // Re-render feather icons inside new row
    feather.replace();

    // Focus on description
    setTimeout(() => {
        row.querySelector('[name="description"]').focus();
    }, 50);
}

// Remove item row
function removeItemRow(row) {
    if (document.querySelectorAll('.item-row').length <= 1) {
        alert('At least one item is required');
        return;
    }
    row.remove();
    updateItemNumbers();
    updateInvoiceSummary();
}

// Update row numbers
function updateItemNumbers() {
    const rows = document.querySelectorAll('.item-row');
    rows.forEach((row, index) => {
        row.querySelector('.item-number').textContent = index + 1;
    });
}

// Calculate line item amount
function calculateItemAmount(row) {
    const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
    const unitPrice = parseFloat(row.querySelector('[name="unit_price"]').value) || 0;
    const taxPercentage = parseFloat(row.querySelector('[name="tax_percentage"]').value) || 0;

    const lineTotal = quantity * unitPrice;
    const taxAmount = (lineTotal * taxPercentage) / 100;
    const totalAmount = lineTotal + taxAmount;

    row.querySelector('.item-amount').textContent = `â‚¹${totalAmount.toFixed(2)}`;
}

// Update invoice summary
function updateInvoiceSummary() {
    let subtotal = 0;
    let totalTax = 0;

    document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
        const unitPrice = parseFloat(row.querySelector('[name="unit_price"]').value) || 0;
        const taxPercentage = parseFloat(row.querySelector('[name="tax_percentage"]').value) || 0;

        const lineTotal = quantity * unitPrice;
        const taxAmount = (lineTotal * taxPercentage) / 100;

        subtotal += lineTotal;
        totalTax += taxAmount;
    });

    const clientSelect = document.getElementById('client_id');
    const selectedClient = clientSelect.options[clientSelect.selectedIndex];

    let cgst = 0, sgst = 0, igst = 0;
    if (selectedClient && selectedClient.dataset.address && selectedClient.dataset.address.includes('Tamil Nadu')) {
        cgst = totalTax / 2;
        sgst = totalTax / 2;
    } else {
        igst = totalTax;
    }

    const total = subtotal + totalTax;

    document.getElementById('subtotalAmount').textContent = `â‚¹${subtotal.toFixed(2)}`;
    document.getElementById('cgstAmount').textContent = `â‚¹${cgst.toFixed(2)}`;
    document.getElementById('sgstAmount').textContent = `â‚¹${sgst.toFixed(2)}`;
    document.getElementById('igstAmount').textContent = `â‚¹${igst.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `â‚¹${total.toFixed(2)}`;

    document.getElementById('amountInWords').textContent = `${convertNumberToWords(Math.floor(total))} Rupees Only`;
}

// Convert number to words (simplified)
function convertNumberToWords(num) {
    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const teens = ['Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
    const tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
    if (num===0) return 'Zero';
    if (num<10) return ones[num];
    if (num<20) return teens[num-10];
    if (num<100) return tens[Math.floor(num/10)] + (num%10!==0 ? ' ' + ones[num%10] : '');
    if (num<1000) return ones[Math.floor(num/100)] + ' Hundred' + (num%100!==0 ? ' ' + convertNumberToWords(num%100) : '');
    if (num<100000) return convertNumberToWords(Math.floor(num/1000)) + ' Thousand' + (num%1000!==0 ? ' ' + convertNumberToWords(num%1000) : '');
    if (num<10000000) return convertNumberToWords(Math.floor(num/100000)) + ' Lakh' + (num%100000!==0 ? ' ' + convertNumberToWords(num%100000) : '');
    return convertNumberToWords(Math.floor(num/10000000)) + ' Crore' + (num%10000000!==0 ? ' ' + convertNumberToWords(num%10000000) : '');
}

// Save invoice
function saveInvoice() {
    const rows = document.querySelectorAll('.item-row');
    lineItems = [];

    rows.forEach(row => {
        const description = row.querySelector('[name="description"]').value.trim();
        if (description) {
            lineItems.push({
                hsn_code: row.querySelector('[name="hsn_code"]').value,
                description: description,
                quantity: parseFloat(row.querySelector('[name="quantity"]').value) || 0,
                unit: row.querySelector('[name="unit"]').value,
                unit_price: parseFloat(row.querySelector('[name="unit_price"]').value) || 0,
                tax_percentage: parseFloat(row.querySelector('[name="tax_percentage"]').value) || 0
            });
        }
    });

    if (lineItems.length === 0) {
        alert('Please add at least one item to the invoice.');
        return;
    }

    document.getElementById('line_items').value = JSON.stringify(lineItems);
    document.getElementById('invoiceForm').submit();
}
</script>
{% endblock %}
