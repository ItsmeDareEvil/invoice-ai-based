{% extends "base.html" %}

{% block title %}Create Invoice - Revolutionary Invoice System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-6 fw-bold text-primary mb-1">
                            <i data-feather="file-plus" class="me-2"></i>
                            Create New Invoice
                        </h1>
                        <p class="text-muted mb-0">
                            Generate professional invoices with AI assistance
                            {% if ai_enabled %} â€¢ Voice commands enabled{% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex gap-2 justify-content-end">
                            {% if ai_enabled %}
                            <button class="btn btn-success glass-btn" id="voiceAssistBtn">
                                <i data-feather="mic" class="me-1"></i> Voice Assist
                            </button>
                            <button class="btn btn-info glass-btn" data-bs-toggle="modal" data-bs-target="#documentScannerModal">
                                <i data-feather="camera" class="me-1"></i> Scan Document
                            </button>
                            {% endif %}
                            <a href="{{ url_for('invoice_management') }}" class="btn btn-outline-secondary glass-btn">
                                <i data-feather="arrow-left" class="me-1"></i> Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invoice Form -->
    <form method="POST" id="invoiceForm">
        <div class="row">
            <!-- Left Column - Invoice Details -->
            <div class="col-lg-8">
                <div class="glass-card p-4 mb-4">
                    <h5 class="fw-bold mb-3">
                        <i data-feather="info" class="me-2 text-primary"></i>
                        Invoice Information
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client_id" class="form-label">Client *</label>
                                <div class="input-group">
                                    <select class="form-select glass-input" id="client_id" name="client_id" required>
                                        <option value="">Select a client...</option>
                                        {% for client in clients %}
                                        <option value="{{ client.id }}" 
                                                data-email="{{ client.email }}" 
                                                data-phone="{{ client.phone }}"
                                                data-address="{{ client.address }}"
                                                data-gstin="{{ client.gstin }}">
                                            {{ client.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <a href="{{ url_for('create_client') }}" class="btn btn-outline-primary" >
                                        <i data-feather="user-plus" size="16"></i>
                                    </a>
                                </div>
                                <div id="clientPreview" class="client-preview mt-2" style="display: none;">
                                    <small class="text-muted">
                                        <div id="clientInfo"></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="invoice_date" class="form-label">Invoice Date *</label>
                                <input type="date" class="form-control glass-input" id="invoice_date" name="invoice_date" 
                                       value="{{ today.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control glass-input" id="due_date" name="due_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control glass-input" id="notes" name="notes" rows="3" 
                                          placeholder="Additional notes for this invoice..."></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="terms_conditions" class="form-label">Terms & Conditions</label>
                                <textarea class="form-control glass-input" id="terms_conditions" name="terms_conditions" rows="3" 
                                          placeholder="Payment terms and conditions...">Payment due within 30 days of invoice date.
Interest @ 2% per month will be charged on overdue amounts.
Subject to local jurisdiction only.</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Line Items -->
                <div class="glass-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">
                            <i data-feather="list" class="me-2 text-primary"></i>
                            Invoice Items
                        </h5>
                        <div class="d-flex gap-2">
                            {% if ai_enabled %}
                            <button type="button" class="btn btn-info btn-sm glass-btn" id="aiSuggestionsBtn">
                                <i data-feather="cpu" class="me-1"></i> AI Suggestions
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-primary btn-sm glass-btn" id="addItemBtn">
                                <i data-feather="plus" class="me-1"></i> Add Item
                            </button>
                        </div>
                    </div>
                    
                    <!-- Items Table -->
                    <div class="table-responsive">
                        <table class="table table-borderless" id="itemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">#</th>
                                    <th width="100">HSN Code</th>
                                    <th>Description *</th>
                                    <th width="80">Qty *</th>
                                    <th width="60">Unit</th>
                                    <th width="120">Rate *</th>
                                    <th width="80">Tax %</th>
                                    <th width="120">Amount</th>
                                    <th width="50">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- AI Suggestions Panel -->
                    {% if ai_enabled %}
                    <div id="aiSuggestionsPanel" class="ai-suggestions-panel mt-3" style="display: none;">
                        <div class="glass-card-sm p-3">
                            <h6 class="text-primary mb-2">
                                <i data-feather="cpu" class="me-1"></i> AI Suggestions
                            </h6>
                            <div id="aiSuggestionsList">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                    <small class="text-muted">Generating suggestions...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column - Summary and Actions -->
            <div class="col-lg-4">
                <!-- Invoice Summary -->
                <div class="glass-card p-4 mb-4 sticky-summary">
                    <h5 class="fw-bold mb-3">
                        <i data-feather="calculator" class="me-2 text-primary"></i>
                        Invoice Summary
                    </h5>
                    
                    <div class="summary-section">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotalAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>CGST (9%):</span>
                            <span id="cgstAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>SGST (9%):</span>
                            <span id="sgstAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>IGST (18%):</span>
                            <span id="igstAmount">â‚¹0.00</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between fw-bold text-primary h5">
                            <span>Total Amount:</span>
                            <span id="totalAmount">â‚¹0.00</span>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Amount in Words:</strong><br>
                                <span id="amountInWords">Zero Rupees Only</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-2">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary glass-btn-primary" id="saveInvoiceBtn">
                                <i data-feather="save" class="me-1"></i> Save Invoice
                            </button>
                            
                            <button type="button" class="btn btn-outline-secondary glass-btn" id="previewBtn">
                                <i data-feather="eye" class="me-1"></i> Preview
                            </button>
                            
                            {% if ai_enabled %}
                            <button type="button" class="btn btn-outline-info glass-btn" id="aiAnalyzeBtn">
                                <i data-feather="cpu" class="me-1"></i> AI Analysis
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Invoice Options -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-2">Options</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableQRCode" checked>
                            <label class="form-check-label" for="enableQRCode">
                                Generate QR Code for payments
                            </label>
                        </div>
                        
                        {% if blockchain_enabled %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="blockchainVerify" checked>
                            <label class="form-check-label" for="blockchainVerify">
                                Add to blockchain for verification
                            </label>
                        </div>
                        {% endif %}
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoReminders">
                            <label class="form-check-label" for="autoReminders">
                                Set up automatic payment reminders
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Client Information (if selected) -->
                <div id="clientInfoCard" class="glass-card p-4" style="display: none;">
                    <h6 class="fw-bold mb-2">
                        <i data-feather="user" class="me-2 text-primary"></i>
                        Client Information
                    </h6>
                    <div id="clientDetails"></div>
                </div>
            </div>
        </div>
        
        <!-- Hidden Fields -->
        <input type="hidden" id="line_items" name="line_items" value="[]">
        <input type="hidden" id="ai_generated" name="ai_generated" value="false">
        <input type="hidden" id="voice_created" name="voice_created" value="false">
    </form>
</div>

<!-- Item Row Template -->
<template id="itemRowTemplate">
    <tr class="item-row">
        <td>
            <span class="item-number">1</span>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm glass-input" 
                   placeholder="HSN" name="hsn_code">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm glass-input" 
                   placeholder="Item description" name="description" required>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm glass-input" 
                   placeholder="1" name="quantity" min="0" step="0.01" required>
        </td>
        <td>
            <select class="form-select form-select-sm glass-input" name="unit">
                <option value="Nos">Nos</option>
                <option value="Kg">Kg</option>
                <option value="Ltr">Ltr</option>
                <option value="Mtr">Mtr</option>
                <option value="Hrs">Hrs</option>
                <option value="Days">Days</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm glass-input" 
                   placeholder="0.00" name="unit_price" min="0" step="0.01" required>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm glass-input" 
                   placeholder="18" name="tax_percentage" min="0" max="100" step="0.01" value="18">
        </td>
        <td>
            <div class="item-amount fw-bold">â‚¹0.00</div>
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn">
                <i data-feather="trash-2" size="14"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
<script>
let itemCounter = 0;
let lineItems = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize form
    initializeInvoiceForm();
    
    // Add first item row
    addItemRow();
    
    // Client selection change
    document.getElementById('client_id').addEventListener('change', function() {
        handleClientSelection();
        
        {% if ai_enabled %}
        // Load AI suggestions for selected client
        if (this.value) {
            loadAISuggestions(this.value);
        }
        {% endif %}
    });
    
    // Auto-calculate due date (30 days from invoice date)
    document.getElementById('invoice_date').addEventListener('change', function() {
        const invoiceDate = new Date(this.value);
        const dueDate = new Date(invoiceDate.getTime() + (30 * 24 * 60 * 60 * 1000));
        document.getElementById('due_date').value = dueDate.toISOString().split('T')[0];
    });
    
    // Form submission
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveInvoice();
    });
    
    // Voice assistance
    {% if ai_enabled %}
    document.getElementById('voiceAssistBtn').addEventListener('click', function() {
        startVoiceAssistance();
    });
    
    document.getElementById('aiSuggestionsBtn').addEventListener('click', function() {
        toggleAISuggestions();
    });
    
    document.getElementById('aiAnalyzeBtn').addEventListener('click', function() {
        analyzeInvoiceWithAI();
    });
    {% endif %}
});

//invoice saving 
document.getElementById("saveInvoiceBtn").addEventListener("click", function (event) {
  event.preventDefault();

  const form = document.querySelector("form");
  const btn = this;
  const formData = new FormData(form);

  btn.disabled = true;
  btn.innerHTML = '<i data-feather="loader" class="me-1 spin"></i> Saving...';
  feather.replace();

  fetch(form.action, {
    method: form.method,
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" } // ðŸ”‘ so Flask knows it's AJAX
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
       window.location.href = data.invoice_url; // redirect in same tab

        form.reset();
        alert("Invoice saved successfully!");
      } else {
        alert("Error: " + (data.error || "Could not save invoice."));
      }
    })
    .catch(err => {
      alert("Unexpected error: " + err);
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = '<i data-feather="save" class="me-1"></i> Save Invoice';
      feather.replace();
    });
});






function initializeInvoiceForm() {
    // Add item button
    document.getElementById('addItemBtn').addEventListener('click', addItemRow);
    
    // Preview button
    document.getElementById('previewBtn').addEventListener('click', previewInvoice);
}

function addItemRow(suggestion = null) {
    itemCounter++;
    const template = document.getElementById('itemRowTemplate');
    const clone = template.content.cloneNode(true);
    
    // Update item number
    clone.querySelector('.item-number').textContent = itemCounter;
    
    // Set suggestion data if provided
    if (suggestion) {
        clone.querySelector('[name="description"]').value = suggestion.description || '';
        clone.querySelector('[name="quantity"]').value = suggestion.quantity || 1;
        clone.querySelector('[name="unit_price"]').value = suggestion.unit_price || 0;
        clone.querySelector('[name="hsn_code"]').value = suggestion.hsn_code || '';
    }
    
    // Add event listeners
    const row = clone.querySelector('.item-row');
    addItemEventListeners(row);
    
    // Append to table
    document.getElementById('itemsTableBody').appendChild(clone);
    
    // Focus on description field
    setTimeout(() => {
        row.querySelector('[name="description"]').focus();
    }, 100);
}

function addItemEventListeners(row) {
    const inputs = row.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            calculateItemAmount(row);
            updateInvoiceSummary();
        });
        
        input.addEventListener('change', function() {
            calculateItemAmount(row);
            updateInvoiceSummary();
        });
    });
    
    // Remove item button
    const removeBtn = row.querySelector('.remove-item-btn');
    removeBtn.addEventListener('click', function() {
        removeItemRow(row);
    });
}

function removeItemRow(row) {
    if (document.querySelectorAll('.item-row').length <= 1) {
        alert('At least one item is required');
        return;
    }
    
    row.remove();
    updateItemNumbers();
    updateInvoiceSummary();
}

function updateItemNumbers() {
    const rows = document.querySelectorAll('.item-row');
    rows.forEach((row, index) => {
        row.querySelector('.item-number').textContent = index + 1;
    });
}

function calculateItemAmount(row) {
    const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
    const unitPrice = parseFloat(row.querySelector('[name="unit_price"]').value) || 0;
    const taxPercentage = parseFloat(row.querySelector('[name="tax_percentage"]').value) || 0;
    
    const lineTotal = quantity * unitPrice;
    const taxAmount = (lineTotal * taxPercentage) / 100;
    const totalAmount = lineTotal + taxAmount;
    
    row.querySelector('.item-amount').textContent = `â‚¹${totalAmount.toFixed(2)}`;
}

function updateInvoiceSummary() {
    let subtotal = 0;
    let totalTax = 0;
    
    const rows = document.querySelectorAll('.item-row');
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
        const unitPrice = parseFloat(row.querySelector('[name="unit_price"]').value) || 0;
        const taxPercentage = parseFloat(row.querySelector('[name="tax_percentage"]').value) || 0;
        
        const lineTotal = quantity * unitPrice;
        const taxAmount = (lineTotal * taxPercentage) / 100;
        
        subtotal += lineTotal;
        totalTax += taxAmount;
    });
    
    const clientSelect = document.getElementById('client_id');
    const selectedClient = clientSelect.options[clientSelect.selectedIndex];
    
    // Determine tax split based on client state (simplified logic)
    let cgst = 0, sgst = 0, igst = 0;
    
    if (selectedClient && selectedClient.dataset.address && selectedClient.dataset.address.includes('Tamil Nadu')) {
        // Same state - CGST + SGST
        cgst = totalTax / 2;
        sgst = totalTax / 2;
    } else {
        // Different state - IGST
        igst = totalTax;
    }
    
    const total = subtotal + totalTax;
    
    // Update summary display
    document.getElementById('subtotalAmount').textContent = `â‚¹${subtotal.toFixed(2)}`;
    document.getElementById('cgstAmount').textContent = `â‚¹${cgst.toFixed(2)}`;
    document.getElementById('sgstAmount').textContent = `â‚¹${sgst.toFixed(2)}`;
    document.getElementById('igstAmount').textContent = `â‚¹${igst.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `â‚¹${total.toFixed(2)}`;
    
    // Update amount in words
    updateAmountInWords(total);
}

function updateAmountInWords(amount) {
    // This would typically call a backend API to convert numbers to words
    // For now, we'll use a simple implementation
    const words = convertNumberToWords(Math.floor(amount));
    document.getElementById('amountInWords').textContent = `${words} Rupees Only`;
}

function handleClientSelection() {
    const clientSelect = document.getElementById('client_id');
    const selectedOption = clientSelect.options[clientSelect.selectedIndex];
    
    if (selectedOption.value) {
        const clientInfo = {
            email: selectedOption.dataset.email,
            phone: selectedOption.dataset.phone,
            address: selectedOption.dataset.address,
            gstin: selectedOption.dataset.gstin
        };
        
        displayClientInfo(clientInfo);
        showClientPreview(clientInfo);
    } else {
        hideClientInfo();
    }
}

function displayClientInfo(clientInfo) {
    const clientDetails = document.getElementById('clientDetails');
    const clientInfoCard = document.getElementById('clientInfoCard');
    
    clientDetails.innerHTML = `
        <div class="small">
            ${clientInfo.email ? `<div><i data-feather="mail" size="14" class="me-1"></i> ${clientInfo.email}</div>` : ''}
            ${clientInfo.phone ? `<div><i data-feather="phone" size="14" class="me-1"></i> ${clientInfo.phone}</div>` : ''}
            ${clientInfo.gstin ? `<div><i data-feather="hash" size="14" class="me-1"></i> GSTIN: ${clientInfo.gstin}</div>` : ''}
        </div>
    `;
    
    clientInfoCard.style.display = 'block';
    feather.replace();
}

function showClientPreview(clientInfo) {
    const clientPreview = document.getElementById('clientPreview');
    const clientInfoDiv = document.getElementById('clientInfo');
    
    clientInfoDiv.innerHTML = `
        ${clientInfo.email || ''} ${clientInfo.phone ? `â€¢ ${clientInfo.phone}` : ''}
    `;
    
    clientPreview.style.display = 'block';
}

function hideClientInfo() {
    document.getElementById('clientInfoCard').style.display = 'none';
    document.getElementById('clientPreview').style.display = 'none';
}

function saveInvoice() {
    // Collect line items data
    const rows = document.querySelectorAll('.item-row');
    lineItems = [];
    
    rows.forEach(row => {
        const description = row.querySelector('[name="description"]').value.trim();
        if (description) {
            lineItems.push({
                hsn_code: row.querySelector('[name="hsn_code"]').value,
                description: description,
                quantity: parseFloat(row.querySelector('[name="quantity"]').value) || 0,
                unit: row.querySelector('[name="unit"]').value,
                unit_price: parseFloat(row.querySelector('[name="unit_price"]').value) || 0,
                tax_percentage: parseFloat(row.querySelector('[name="tax_percentage"]').value) || 0
            });
        }
    });
    
    if (lineItems.length === 0) {
        alert('Please add at least one item to the invoice.');
        return;
    }
    
    // Update hidden field
    document.getElementById('line_items').value = JSON.stringify(lineItems);
    
    // Submit form
    const submitBtn = document.getElementById('saveInvoiceBtn');
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    submitBtn.disabled = true;
    
    document.getElementById('invoiceForm').submit();
}

function previewInvoice() {
    // Create a preview modal or new window
    alert('Preview functionality will open a new window with invoice preview.');
}

// AI-powered functions
{% if ai_enabled %}
function startVoiceAssistance() {
    const modal = new bootstrap.Modal(document.getElementById('voiceCommandModal'));
    modal.show();
}

function toggleAISuggestions() {
    const panel = document.getElementById('aiSuggestionsPanel');
    const clientId = document.getElementById('client_id').value;
    
    if (!clientId) {
        alert('Please select a client first to get AI suggestions.');
        return;
    }
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        loadAISuggestions(clientId);
    } else {
        panel.style.display = 'none';
    }
}

function loadAISuggestions(clientId) {
    const suggestionsList = document.getElementById('aiSuggestionsList');
    
    // Show loading
    suggestionsList.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
            <small class="text-muted">Generating AI suggestions...</small>
        </div>
    `;
    
    // Fetch AI suggestions
    fetch(`/api/ai_suggestions/${clientId}`)
        .then(response => response.json())
        .then(data => {
            displayAISuggestions(data.suggestions || []);
        })
        .catch(error => {
            console.error('Error loading AI suggestions:', error);
            suggestionsList.innerHTML = `
                <div class="text-center py-3">
                    <small class="text-danger">Failed to load suggestions</small>
                </div>
            `;
        });
}

function displayAISuggestions(suggestions) {
    const suggestionsList = document.getElementById('aiSuggestionsList');
    
    if (suggestions.length === 0) {
        suggestionsList.innerHTML = `
            <div class="text-center py-3">
                <small class="text-muted">No suggestions available for this client</small>
            </div>
        `;
        return;
    }
    
    const suggestionsHtml = suggestions.map(suggestion => `
        <div class="suggestion-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
                <div class="fw-medium">${suggestion.description}</div>
                <small class="text-muted">
                    Qty: ${suggestion.quantity} â€¢ Rate: â‚¹${suggestion.unit_price} 
                    â€¢ Confidence: ${Math.round((suggestion.confidence || 0) * 100)}%
                </small>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="addAISuggestion(${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
                Add
            </button>
        </div>
    `).join('');
    
    suggestionsList.innerHTML = suggestionsHtml;
}

function addAISuggestion(suggestion) {
    addItemRow(suggestion);
    document.getElementById('ai_generated').value = 'true';
}

function analyzeInvoiceWithAI() {
    // Implement AI analysis of current invoice
    alert('AI Analysis: This invoice looks good! Recommended payment terms: 30 days.');
}
{% endif %}

// Utility function for number to words conversion (simplified)
function convertNumberToWords(num) {
    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
    const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    
    if (num === 0) return 'Zero';
    if (num < 10) return ones[num];
    if (num < 20) return teens[num - 10];
    if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + ones[num % 10] : '');
    if (num < 1000) return ones[Math.floor(num / 100)] + ' Hundred' + (num % 100 !== 0 ? ' ' + convertNumberToWords(num % 100) : '');
    if (num < 100000) return convertNumberToWords(Math.floor(num / 1000)) + ' Thousand' + (num % 1000 !== 0 ? ' ' + convertNumberToWords(num % 1000) : '');
    if (num < 10000000) return convertNumberToWords(Math.floor(num / 100000)) + ' Lakh' + (num % 100000 !== 0 ? ' ' + convertNumberToWords(num % 100000) : '');
    
    return convertNumberToWords(Math.floor(num / 10000000)) + ' Crore' + (num % 10000000 !== 0 ? ' ' + convertNumberToWords(num % 10000000) : '');
}

// Sticky summary positioning
window.addEventListener('scroll', function() {
    const summary = document.querySelector('.sticky-summary');
    const rect = summary.getBoundingClientRect();
    
    if (rect.top <= 100) {
        summary.style.position = 'sticky';
        summary.style.top = '100px';
    }
});
</script>
{% endblock %}
